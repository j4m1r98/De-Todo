<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Kick Chat - Tizen</title>
<style>
body{font-family:Arial;background:#0d1117;color:#e6edf3;margin:0}
header{padding:12px;background:#161b22;border-bottom:1px solid:#30363d;display:flex;gap:12px;align-items:center}
input,button{padding:8px;border-radius:6px;border:1px solid:#30363d;background:#0d1117;color:#e6edf3}
button{cursor:pointer;font-weight:bold}
main{display:flex;height:calc(100vh - 60px)}
aside{width:240px;background:#161b22;padding:8px;overflow:auto;border-right:1px solid:#30363d}
#messages{flex:1;padding:10px;overflow:auto;font-size:16px}

.msg{display:flex;gap:6px;margin-bottom:8px;padding:6px 10px;background:#1e2630;border-radius:8px}
.username{font-weight:bold;margin-right:6px}
.chat-emote{height:26px;margin:0 2px;vertical-align:middle;image-rendering:pixelated}

.console{font-size:10px;white-space:pre-wrap;background:#0d1117;border:1px solid:#30363d;
padding:6px;height:100px;overflow:auto;margin-top:10px;border-radius:6px}
footer{padding:8px;border-top:1px solid:#30363d;background:#161b22;text-align:center;font-size:12px;color:#8b949e}
</style>
</head>
<body>

<header>
  <input id="room" type="number" placeholder="ID sala Kick">
  <button id="join">Unirse</button>
  <button id="clear">Limpiar</button>
</header>

<main>
  <aside>
    <h4>Salas</h4>
    <div id="roomsList"></div>
    <div class="console" id="log"></div>
  </aside>
  <div id="messages"></div>
</main>

<footer>Kick Chat Viewer — Tizen ✅</footer>

<script>
var rooms = {};
var emotes = {};
var ws;

function log(m){
  var el = document.getElementById("log");
  el.innerText += "[" + new Date().toLocaleTimeString() + "] " + m + "\n";
  el.scrollTop = el.scrollHeight;
}

/* ========= Cargar emotes globales 7TV (XMLHttpRequest) ========= */
function loadGlobal7TV(){
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://7tv.io/v3/emote-sets/global", true);
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        var d = JSON.parse(xhr.responseText);
        for(var i=0;i<d.emotes.length;i++){
          var e = d.emotes[i];
          emotes[e.name] = "https:" + e.data.host.url + "/3x." + e.data.host.files[0].format;
        }
        log("7TV global ok");
      }
    }
  };
  xhr.send();
}
loadGlobal7TV();

/* ========= Cargar emotes del canal 7TV ========= */
function loadRoom7TV(room){
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://7tv.io/v3/users/kick/" + room, true);
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        var d = JSON.parse(xhr.responseText);
        if(d.emote_set && d.emote_set.emotes){
          var arr = d.emote_set.emotes;
          for(var i=0;i<arr.length;i++){
            var e = arr[i];
            emotes[e.name] = "https:" + e.data.host.url + "/3x." + e.data.host.files[0].format;
          }
          log("7TV canal cargado " + room);
        }
      }
    }
  };
  xhr.send();
}

/* ========= Color usuario ========= */
function nameColor(name){
  var h = 0;
  for(var i=0;i<name.length;i++) h += name.charCodeAt(i);
  return "hsl(" + (h%360) + ",70%,75%)";
}

/* ========= Reemplazar palabras por emotes ========= */
function parseEmotes(text){
  var parts = text.split(" ");
  for(var i=0;i<parts.length;i++){
    if(emotes[parts[i]]){
      parts[i] = '<img class="chat-emote" src="'+emotes[parts[i]]+'">';
    }
  }
  return parts.join(" ");
}

/* ========= Mostrar mensaje ========= */
function addMsg(user, text){
  var box = document.getElementById("messages");
  var div = document.createElement("div");
  div.className = "msg";

  var html =
    '<span class="username" style="color:'+nameColor(user)+'">'+user+':</span>' +
    '<span>'+parseEmotes(text)+'</span>';

  div.innerHTML = html;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* ========= Conectar WebSocket ========= */
function connectWS(){
  ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0&flash=false");

  ws.onopen = function(){ log("Conectado ✅"); };
  ws.onerror = function(){ log("Error ❌"); };
  ws.onclose = function(e){ log("Cerrado "+e.code); };

  ws.onmessage = function(ev){
    try{
      var outer = JSON.parse(ev.data);
      if(!outer.data) return;
      var inner = JSON.parse(outer.data);
      if(inner && inner.sender && inner.sender.username && inner.content){
        addMsg(inner.sender.username, inner.content);
      }
    }catch(e){}
  };
}
connectWS();

/* ========= Suscribir sala ========= */
function subscribeRoom(id){
  if(rooms[id]) return;
  rooms[id] = true;

  ws.send(JSON.stringify({
    event:"pusher:subscribe",
    data:{auth:"",channel:"chatrooms."+id+".v2"}
  }));

  loadRoom7TV(id);

  var list = document.getElementById("roomsList");
  var d = document.createElement("div");
  d.innerText = "• " + id;
  list.appendChild(d);

  log("Entrando sala " + id);
}

/* ========= Botones ========= */
document.getElementById("join").onclick = function(){
  var id = document.getElementById("room").value;
  if(id) subscribeRoom(id);
};

document.getElementById("clear").onclick = function(){
  document.getElementById("messages").innerHTML = "";
};
</script>
</body>
</html>
