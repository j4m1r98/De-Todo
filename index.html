<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Kick Chat Viewer</title>
<style>
body{font-family:Arial;background:#0d1117;color:#e6edf3;margin:0}
header{padding:12px;background:#161b22;border-bottom:1px solid:#30363d;display:flex;gap:12px;align-items:center}
input,button{padding:8px;border-radius:6px;border:1px solid:#30363d;background:#0d1117;color:#e6edf3}
button{cursor:pointer;font-weight:bold}
main{display:flex;height:calc(100vh - 60px)}
aside{width:260px;background:#161b22;padding:10px;overflow:auto;border-right:1px solid:#30363d}
#messages{flex:1;padding:10px;overflow:auto}

/* Mensajes estilo burbuja */
.msg{
  display:flex;
  gap:6px;
  align-items:flex-start;
  margin-bottom:8px;
  padding:8px 12px;
  background:#1e2630;
  border-radius:10px;
  font-size:15px;
  line-height:1.35;
  animation:fadeIn .15s ease-out;
}

@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* Usuario */
.username{
  font-weight:bold;
  margin-right:6px;
}

/* Emotes */
.chat-emote{
  height:28px;
  vertical-align:middle;
  margin:0 2px;
  image-rendering:pixelated;
}

.console{
  font-size:11px;white-space:pre-wrap;background:#0d1117;border:1px solid:#30363d;
  padding:6px;height:120px;overflow:auto;margin-top:10px;border-radius:6px
}
footer{padding:10px;border-top:1px solid:#30363d;background:#161b22;text-align:center;font-size:12px;color:#8b949e}
</style>
</head>
<body>

<header>
  <input id="room" type="number" placeholder="ID sala Kick ej: 4598">
  <button id="join">Unirse</button>
  <button id="clear">Limpiar chat</button>
</header>

<main>
  <aside>
    <h4>Salas activas</h4>
    <div id="roomsList"></div>
    <div class="console" id="log"></div>
  </aside>
  <div id="messages"></div>
</main>

<footer>Kick WebSocket Viewer â€” Solo lectura âœ…</footer>

<script>
const log = m=>{
  const el=document.getElementById("log");
  el.textContent+=`[${new Date().toLocaleTimeString()}] ${m}\n`;
  el.scrollTop=el.scrollHeight;
};

const ws=new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0&flash=false");
ws.onopen = ()=>log("âœ… Conectado a Kick WebSocket");
ws.onerror = ()=>log("âŒ Error");
ws.onclose = e=>log("âš ï¸ Desconectado: "+e.code);

const rooms=new Set();
let emotes={};

/* =======================
   7TV EMOTES GLOBAL
   ======================= */

fetch("https://7tv.io/v3/emote-sets/global")
  .then(r=>r.json())
  .then(d=>{
    for(const e of d.emotes){
      const url = e.data.host.url + `/3x.${e.data.host.files[0].format}`;
      emotes[e.name] = "https:" + url;
    }
    log("ðŸŒ Emotes globales 7TV listos");
  });

/* =======================
   7TV EMOTES POR CANAL KICK
   ======================= */
async function loadRoomEmotes(room){
  try{
    const res = await fetch(`https://7tv.io/v3/users/kick/${room}`);
    const data = await res.json();

    if(data.emote_set?.emotes){
      data.emote_set.emotes.forEach(e=>{
        const url = e.data.host.url + `/3x.${e.data.host.files[0].format}`;
        emotes[e.name] = "https:" + url;
      });
      log(`ðŸŽ­ Emotes cargados para sala ${room}`);
    } else {
      log(`âš ï¸ No hay emotes 7TV en sala ${room}`);
    }
  }catch{
    log("âš ï¸ Error cargando emotes 7TV");
  }
}

function subscribeRoom(id){
  if(rooms.has(id)) return;
  rooms.add(id);
  updateRoomsUI();

  ws.send(JSON.stringify({
    event:"pusher:subscribe",
    data:{auth:"",channel:`chatrooms.${id}.v2`}
  }));

  loadRoomEmotes(id);
  log(`ðŸ“¡ Suscrito a sala ${id}`);
}

function updateRoomsUI(){
  const div=document.getElementById("roomsList");
  div.innerHTML="";
  rooms.forEach(id=>{
    const r=document.createElement("div");
    r.textContent=`â€¢ ${id}`;
    div.appendChild(r);
  });
}

/* Reemplazar texto por emote si existe */
function parseEmotes(text){
  return text.split(" ").map(w =>
    emotes[w] ? `<img class="chat-emote" src="${emotes[w]}">` : w
  ).join(" ");
}

/* Color segÃºn nombre usuario */
function nameColor(name){
  const hash=[...name].reduce((a,c)=>a+c.charCodeAt(0),0);
  const hue=hash % 360;
  return `hsl(${hue},70%,75%)`;
}

ws.onmessage = ev=>{
  try{
    const outer=JSON.parse(ev.data);
    if(!outer.data) return;
    const inner=JSON.parse(outer.data);
    if(inner?.sender?.username && inner?.content){
      addMsg(inner.sender.username, inner.content);
    }
  }catch{}
};

function addMsg(user,text){
  const box=document.getElementById("messages");
  const div=document.createElement("div");
  div.className="msg";

  const color=nameColor(user);
  const parsed=parseEmotes(text);

  div.innerHTML = `
    <span class="username" style="color:${color}">${user}:</span>
    <span>${parsed}</span>
  `;

  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

document.getElementById("join").onclick=()=>{
  const id=document.getElementById("room").value;
  if(id) subscribeRoom(id);
};

document.getElementById("clear").onclick=()=>{
  document.getElementById("messages").innerHTML="";
};
</script>
</body>
</html>
