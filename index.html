<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Kick Chat Only - Tizen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body{
  font-family:Arial, sans-serif;
  background:#0d1117;
  color:#e6edf3;
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.titulo {
  padding:8px 12px;
  background:#161b22;
  border-bottom:2px solid #30363d;
  text-align:center;
  font-size:1rem;
  line-height:1.5rem;
  font-weight:700;
  color:#ffffff;
}
#messages-container{
  flex:1;
  position:relative;
  display:flex;
  flex-direction:column;
  padding:12px 0;
  min-width:0;
  min-height:0;
}
#messages{
  flex:1; 
  overflow:auto;    
}

/* Mensajes */
.msg{
  color:#ffffff;
  font-weight:500;
  font-size:1rem;
  line-height:1.25rem;
  margin:0 6px;
  margin-top:2px;
  padding:4px 8px;
}
.username{
  font-size:1rem;
  line-height:1.25rem;
  font-weight:700;  
  white-space:normal;
}
.colon{
  color:#ffffff;
  font-size:1rem;
  line-height:1.25rem;
  font-weight:900;
  margin-right:2px;
  white-space:normal;
}
.msg span:last-child{
  word-break:break-word;
}
.chat-emote{
  height:20px;
  margin:0 2px;
  vertical-align:middle;
  image-rendering:pixelated;
}

/* BotÃ³n scroll */
#scrollBottomBtn{  
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:70%;
  max-width:400px;
  background:#3A3B40;
  color:#ffffff;
  font-size:14px;
  align-items: center;
  justify-content: center;
  display:flex;
  border:none;
  border-radius:4px;
  padding:8px 10px;
  font-weight:700;
  cursor:pointer;
  display:none;
  z-index:10;
}
#scrollBottomBtn i{
  font-size: 16px;
  margin-right:6px;
}
.footer{
  padding:8px;
  border-top:1px solid #30363d;
  background:#161b22;
  text-align:center;
  font-size:12px;color:#8b949e
}
/* Responsive */
@media(max-width:600px){
  #scrollBottomBtn{ width:74%; }
}
</style>
</head>
<body>
<div class="titulo">Chat</div>
<div id="messages-container">
  <div id="messages"></div>
  <button id="scrollBottomBtn"><i class="fas fa-pause"></i>chat en pausa, ir al Ãºltimo mensaje</button>
</div>

<div class="footer">Kick Chat Viewer â€” Tizen âœ…</div>

<script>
/* =========================
   CONFIGURAR CANAL AQUÃ
========================= */
const AUTO_CHANNEL = "Kingteka"; // ðŸ‘ˆ CAMBIA AQUÃ TU CANAL

/* =========================
   LOG INTERNO SOLO CONSOLA
========================= */
var log=(m)=>console.log("[CHAT] "+m);

var ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0");
ws.onopen = ()=>log("âœ… WebSocket conectado");
ws.onerror=()=>log("âŒ Error WebSocket");
ws.onclose=e=>log("âš ï¸ WS cerrado: "+e.code);

var emotes = {};
var rooms = {};
const MAX_MESSAGES = 100;
let pauseRemoval=false;
let pauseRemovalTimer=null;

const messagesBox=document.getElementById("messages");
const scrollBtn=document.getElementById("scrollBottomBtn");

/* ===== 7TV GLOBAL ===== */
fetch("https://7tv.io/v3/emote-sets/global")
.then(r=>r.json()).then(d=>{
  d.emotes.forEach(e=>{
    emotes[e.name]="https:"+e.data.host.url+"/3x";
  });
  log("ðŸŒ 7TV Global OK");
});

/* ===== 7TV CANAL ===== */
function load7TV(name){
  fetch("https://7tv.io/v3/users/kick/"+name)
  .then(r=>r.json())
  .then(d=>{
    if(d.emote_set?.emotes){
      d.emote_set.emotes.forEach(e=>{
        emotes[e.name]="https:"+e.data.host.url+"/3x."+e.data.host.files[0].format;
      });
      log("ðŸŽ­ 7TV canal OK");
    }
  }).catch(()=>log("âš ï¸ Error 7TV canal"));
}

/* ===== EMOTES KICK ===== */
function loadKickEmotes(name){
  fetch("https://kick.com/emotes/"+name)
  .then(r=>{ log("ðŸ” Emotes Kick status "+r.status); return r.json(); })
  .then(data=>{
    let count=0;
    data.forEach(sec=>{
      sec.emotes?.forEach(e=>{
        emotes[e.name]="https://files.kick.com/emotes/"+e.id+"/fullsize";
        count++;
      });
    });
    log(count?`âœ… Kick emotes ${count}`:"âš ï¸ No emotes Kick");
  }).catch(()=>log("âŒ Error Kick emotes"));
}

/* ===== GET CHATROOM ID ===== */
function getChatroomId(name,cb){
  fetch("https://kick.com/api/v2/channels/"+name)
  .then(r=>r.json()).then(data=>{
    const id=data.chatroom?.id;
    id?cb(id):log("âš ï¸ Sin chatroom");
  }).catch(()=>log("âŒ Error API canal"));
}

/* ===== SUBSCRIBE ===== */
function joinChannel(name){
  getChatroomId(name, id=>{
    rooms[id]=true;
    if(ws.readyState===1){
      ws.send(JSON.stringify({
        event:"pusher:subscribe",
        data:{auth:"",channel:"chatrooms."+id+".v2"}
      }));
      load7TV(name);
      loadKickEmotes(name);
      log("ðŸ“¡ Conectado al chat");
    }
  });
}

/* ===== PARSE EMOTES ===== */
function parseEmotes(text){
  return text.replace(/\[emote:\d+:(.+?)\]/g,(m,n)=>{
    return emotes[n]?`<img class='chat-emote' src='${emotes[n]}'>`:n;
  });
}

/* ===== NAME COLOR ===== */
function nameColor(n){
  let h=0;for(let i=0;i<n.length;i++)h+=n.charCodeAt(i);
  return "hsl("+(h%360)+",70%,75%)";
}

/* ===== SCROLL EVENT ===== */
messagesBox.addEventListener("scroll",()=>{
  const atBottom = messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 50;
  if(!atBottom){
    pauseRemoval=true;
    scrollBtn.style.display="flex";
    clearTimeout(pauseRemovalTimer);
    pauseRemovalTimer=setTimeout(()=>pauseRemoval=false,60000);
  } else scrollBtn.style.display="none";
});

/* ===== ADD MSG ===== */
function addMsg(user,text){
  const atBottom = messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 50;
  
  const d=document.createElement("div");
  d.className="msg";
  const c=nameColor(user);
  text=parseEmotes(text);

  d.innerHTML=`<span class="username" style="color:${c}">${user}</span><span class="colon">:</span> <span>${text}</span>`;
  messagesBox.appendChild(d);

  if(!pauseRemoval){
    while(messagesBox.children.length>MAX_MESSAGES)
      messagesBox.removeChild(messagesBox.firstChild);
  }

  if(atBottom){
    messagesBox.scrollTop=messagesBox.scrollHeight;
    scrollBtn.style.display="none";
  }
}

/* ===== WS MESSAGE ===== */
ws.onmessage=e=>{
  try{
    const o=JSON.parse(e.data);
    if(!o.data) return;
    const d=JSON.parse(o.data);
    if(d.sender && d.content) addMsg(d.sender.username,d.content);
  }catch{}
};

/* ===== BOTON SCROLL ===== */
scrollBtn.onclick=()=>{
  messagesBox.scrollTop=messagesBox.scrollHeight;
  scrollBtn.style.display="none";
};

/* ===== AUTO-CONNECT ===== */
setTimeout(()=>joinChannel(AUTO_CHANNEL),800);
</script>

</body>
</html>
