<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Kick Chat - Tizen</title>
<style>
body{font-family:Arial;background:#0d1117;color:#e6edf3;margin:0}
header{padding:12px;background:#161b22;border-bottom:1px solid:#30363d;display:flex;gap:12px;align-items:center}
input,button{padding:8px;border-radius:6px;border:1px solid:#30363d;background:#0d1117;color:#e6edf3}
button{cursor:pointer;font-weight:bold}
main{display:flex;height:calc(100vh - 60px)}
aside{width:240px;background:#161b22;padding:8px;overflow:auto;border-right:1px solid:#30363d}
#messages{flex:1;padding:10px;overflow:auto;font-size:16px}
.msg{display:flex;gap:6px;margin-bottom:8px;padding:6px 10px;background:#1e2630;border-radius:8px}
.username{font-weight:bold;margin-right:6px}
.chat-emote{height:26px;margin:0 2px;vertical-align:middle;image-rendering:pixelated}
.console{font-size:10px;white-space:pre-wrap;background:#0d1117;border:1px solid:#30363d;
padding:6px;height:100px;overflow:auto;margin-top:10px;border-radius:6px}
footer{padding:8px;border-top:1px solid:#30363d;background:#161b22;text-align:center;font-size:12px;color:#8b949e}
</style>
</head>
<body>

<header>
  <input id="room" placeholder="Canal Kick ej: Kingteka">
  <button id="join">Unirse</button>
  <button id="clear">Limpiar</button>
</header>

<main>
  <aside>
    <h4>Salas</h4>
    <div id="roomsList"></div>
    <div class="console" id="log"></div>
  </aside>
  <div id="messages"></div>
</main>

<footer>Kick Chat Viewer ‚Äî Tizen ‚úÖ</footer>

<script>
var log = function(m){
  var el=document.getElementById("log");
  el.textContent += "["+new Date().toLocaleTimeString()+"] "+m+"\n";
  el.scrollTop = el.scrollHeight;
};

var ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0&flash=false");
ws.onopen = function(){ log("‚úÖ WebSocket Kick conectado"); };
ws.onerror = function(){ log("‚ùå Error WebSocket"); };
ws.onclose = function(e){ log("‚ö†Ô∏è WS cerrado: "+e.code); };

var rooms = {};
var emotes = {};
var currentChannelName = "";

/* =======================
   7TV GLOBAL
   ======================= */
var xhrG = new XMLHttpRequest();
xhrG.open("GET","https://7tv.io/v3/emote-sets/global");
xhrG.onload = function(){
  if(xhrG.status==200){
    var d = JSON.parse(xhrG.responseText);
    for(var i=0;i<d.emotes.length;i++){
      var e=d.emotes[i];
      var url = "https:" + e.data.host.url + "/3x."+e.data.host.files[0].format;
      emotes[e.name] = url;
    }
    log("üåç 7TV global OK");
  }
};
xhrG.send();

/* =======================
   7TV POR CANAL
   ======================= */
function load7TV(channelName){
  var x = new XMLHttpRequest();
  x.open("GET","https://7tv.io/v3/users/kick/"+channelName);
  x.onload=function(){
    try{
      var d=JSON.parse(x.responseText);
      if(d.emote_set && d.emote_set.emotes){
        for(var i=0;i<d.emote_set.emotes.length;i++){
          var e=d.emote_set.emotes[i];
          var url="https:" + e.data.host.url + "/3x."+e.data.host.files[0].format;
          emotes[e.name]=url;
        }
        log("üé≠ 7TV canal "+channelName+" OK");
      }
    }catch(e){ log("‚ö†Ô∏è Error 7TV canal "+channelName); }
  };
  x.send();
}

/* =======================
   KICK EMOTES
   ======================= */
function loadKickEmotes(channelName){
  var x = new XMLHttpRequest();
  x.open("GET","https://kick.com/emotes/"+channelName);
  x.onload = function(){
    log("üîç Kick emotes ruta respondio status "+x.status+" para canal "+channelName);
    if(x.status!==200){
      log("‚ö†Ô∏è Kick emotes fall√≥ para canal "+channelName);
      return;
    }
    try{
      var data = JSON.parse(x.responseText);
      var count = 0;
      for(var s=0; s<data.length; s++){
        var sec = data[s];
        if(sec.emotes && Array.isArray(sec.emotes)){
          for(var j=0;j<sec.emotes.length;j++){
            var e = sec.emotes[j];
            if(e.id && e.name){
              var url2 = "https://files.kick.com/emotes/"+e.id+"/fullsize";
              emotes[e.name] = url2;
              count++;
            }
          }
        }
      }
      if(count>0){
        log("‚úÖ Emotes Kick cargados ("+count+") para canal "+channelName);
      } else {
        log("‚ö†Ô∏è No se encontraron emotes Kick listables para canal "+channelName);
      }
    }catch(err){ log("‚ö†Ô∏è Error parseando Kick emotes para canal "+channelName+" => "+err); }
  };
  x.onerror=function(){ log("‚ùå Error red al solicitar Kick emotes para canal "+channelName); };
  x.send();
}

/* =======================
   OBTENER CHATROOM ID DESDE WORKER
   ======================= */
function getChatroomId(channelName, callback){
  var x = new XMLHttpRequest();
  var url = "https://strmkckchnnl.j4m1r-98.workers.dev/?channel="+channelName;
  x.open("GET", url);
  x.onload=function(){
    if(x.status==200){
      try{
        var d=JSON.parse(x.responseText);
        if(d.channel_info && d.channel_info.chatroom){
          callback(d.channel_info.chatroom);
          return;
        }
      }catch(e){ log("‚ö†Ô∏è Error parseando Worker: "+e); }
    }
    log("‚ö†Ô∏è No se obtuvo chatroom para "+channelName);
  };
  x.onerror=function(){ log("‚ùå Error red Worker para "+channelName); };
  x.send();
}

/* =======================
   SUSCRIBIR SALA
   ======================= */
function subscribeRoomById(chatroomId){
  if(!chatroomId) return;
  if(!rooms[chatroomId]) rooms[chatroomId] = true;
  updateRoomsUI();

  // Esperar a que WebSocket est√© abierto
  if(ws.readyState === WebSocket.OPEN){
    ws.send(JSON.stringify({
      event:"pusher:subscribe",
      data:{auth:"",channel:"chatrooms."+chatroomId+".v2"}
    }));
  } else {
    ws.addEventListener("open", function onOpen(){
      ws.removeEventListener("open", onOpen);
      ws.send(JSON.stringify({
        event:"pusher:subscribe",
        data:{auth:"",channel:"chatrooms."+chatroomId+".v2"}
      }));
    });
  }

  load7TV(currentChannelName);
  loadKickEmotes(currentChannelName);
  log("üì° Sala unida "+chatroomId);
}

function joinChannel(channelName){
  currentChannelName = channelName;
  getChatroomId(channelName, function(chatroomId){
    if(chatroomId){
      subscribeRoomById(chatroomId);
    } else {
      log("‚ö†Ô∏è No se pudo unir a "+channelName);
    }
  });
}

function updateRoomsUI(){
  var div=document.getElementById("roomsList");
  div.innerHTML="";
  for(var id in rooms){
    var r=document.createElement("div");
    r.textContent="‚Ä¢ "+id;
    div.appendChild(r);
  }
}

/* =======================
   PARSE EMOTES
   ======================= */
function parseEmotes(text){
  // Reemplaza [emote:ID:nombre] por la URL del emote
  return text.replace(/\[emote:\d+:(.+?)\]/g, (match, name)=>{
    if(emotes[name]){
      return "<img class='chat-emote' src='"+emotes[name]+"'>";
    }
    return name; // si no se encuentra el emote, mostrar solo el nombre
  });
}


/* =======================
   COLOR NOMBRE
   ======================= */
function nameColor(n){
  var h=0;
  for(var i=0;i<n.length;i++){h+=n.charCodeAt(i);}
  return "hsl("+(h%360)+",70%,75%)";
}

/* =======================
   MENSAJES WS
   ======================= */
ws.onmessage=function(ev){
  try{
    var o=JSON.parse(ev.data);
    if(!o.data) return;
    var d=JSON.parse(o.data);
    if(d.sender && d.content){
      addMsg(d.sender.username, d.content);
    }
  }catch(e){}
};

function addMsg(user,text){
  var box=document.getElementById("messages");
  var div=document.createElement("div");
  div.className="msg";

  var c=nameColor(user);
  var parsed=parseEmotes(text);

  div.innerHTML="<span class='username' style='color:"+c+"'>"+user+":</span><span>"+parsed+"</span>";

  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

/* =======================
   BOTONES UI
   ======================= */
document.getElementById("join").onclick=function(){
  var channelName = document.getElementById("room").value.trim();
  if(channelName) joinChannel(channelName);
};

document.getElementById("clear").onclick=function(){
  document.getElementById("messages").innerHTML="";
};
</script>

</body>
</html>
