<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Kick Chat Only - Tizen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body{
  font-family:Arial, sans-serif;
  background:#0d1117;
  color:#e6edf3;
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.titulo {
  padding:8px 12px;
  background:#161b22;
  border-bottom:2px solid #30363d;
  text-align:center;
  font-size:1rem;
  line-height:1.5rem;
  font-weight:700;
  color:#ffffff;
}
#messages-container{
  flex:1;
  position:relative;
  display:flex;
  flex-direction:column;
  padding:12px 0;
  min-width:0;
  min-height:0;
}
#messages{
  flex:1; 
  overflow:auto;    
}

/* Mensajes */
.msg{
  color:#ffffff;
  font-weight:500;
  font-size:1rem;
  line-height:1.25rem;
  margin:0 6px;
  margin-top:2px;
  padding:4px 8px;
}
.username{
  font-size:1rem;
  line-height:1.25rem;
  font-weight:700;  
  white-space:normal;
}
.colon{
  color:#ffffff;
  font-size:1rem;
  line-height:1.25rem;
  font-weight:900;
  margin-right:2px;
  white-space:normal;
}
.msg span:last-child{
  word-break:break-word;
}
.chat-emote{
  height:20px;
  margin:0 2px;
  vertical-align:middle;
  image-rendering:pixelated;
}

/* Bot√≥n scroll */
#scrollBottomBtn{  
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:70%;
  max-width:400px;
  background:#3A3B40;
  color:#ffffff;
  font-size:14px;
  align-items: center;
  justify-content: center;
  display:flex;
  border:none;
  border-radius:4px;
  padding:8px 10px;
  font-weight:700;
  cursor:pointer;
  display:none;
  z-index:10;
}
#scrollBottomBtn i{
  font-size: 16px;
  margin-right:6px;
}
.footer{
  padding:8px;
  border-top:1px solid #30363d;
  background:#161b22;
  text-align:center;
  font-size:12px;color:#8b949e
}
/* Responsive */
@media(max-width:600px){
  #scrollBottomBtn{ width:74%; }
}
</style>
</head>
<body>
<div class="titulo">Chat</div>
<div id="messages-container">
  <div id="messages"></div>
  <button id="scrollBottomBtn"><i class="fas fa-pause"></i>chat en pausa, ir al √∫ltimo mensaje</button>
</div>

<div class="footer">Kick Chat Viewer ‚Äî Tizen ‚úÖ</div>

<script>
/* =========================
   CONFIGURAR CANAL AQU√ç
========================= */
var AUTO_CHANNEL = "Kingteka"; // üëà CAMBIA AQU√ç TU CANAL

/* =========================
   LOG INTERNO SOLO CONSOLA
========================= */
var log = function(m) {
  console.log("[CHAT] " + m);
};

var ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0");
ws.onopen = function() { log("‚úÖ WebSocket conectado"); };
ws.onerror = function() { log("‚ùå Error WebSocket"); };
ws.onclose = function(e) { log("‚ö†Ô∏è WS cerrado: " + e.code); };

var emotes = {};
var rooms = {};
var MAX_MESSAGES = 100;
var pauseRemoval = false;
var pauseRemovalTimer = null;

var messagesBox = document.getElementById("messages");
var scrollBtn = document.getElementById("scrollBottomBtn");

/* ===== 7TV GLOBAL ===== */
var xhrGlobal = new XMLHttpRequest();
xhrGlobal.open("GET", "https://7tv.io/v3/emote-sets/global");
xhrGlobal.onload = function() {
  if (xhrGlobal.status === 200) {
    var data = JSON.parse(xhrGlobal.responseText);
    for (var i = 0; i < data.emotes.length; i++) {
      var emote = data.emotes[i];
      emotes[emote.name] = "https:" + emote.data.host.url + "/3x";
    }
    log("üåç 7TV Global OK");
  }
};
xhrGlobal.send();

/* ===== 7TV CANAL ===== */
function load7TV(name) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://7tv.io/v3/users/kick/" + name);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var data = JSON.parse(xhr.responseText);
        if (data.emote_set && data.emote_set.emotes) {
          for (var i = 0; i < data.emote_set.emotes.length; i++) {
            var emote = data.emote_set.emotes[i];
            emotes[emote.name] = "https:" + emote.data.host.url + "/3x." + emote.data.host.files[0].format;
          }
          log("üé≠ 7TV canal OK");
        }
      } catch (e) {
        log("‚ö†Ô∏è Error 7TV canal");
      }
    }
  };
  xhr.send();
}

/* ===== EMOTES KICK ===== */
function loadKickEmotes(name) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://kick.com/emotes/" + name);
  xhr.onload = function() {
    log("üîç Emotes Kick status " + xhr.status);
    if (xhr.status === 200) {
      try {
        var data = JSON.parse(xhr.responseText);
        var count = 0;
        for (var i = 0; i < data.length; i++) {
          var section = data[i];
          if (section.emotes) {
            for (var j = 0; j < section.emotes.length; j++) {
              var emote = section.emotes[j];
              emotes[emote.name] = "https://files.kick.com/emotes/" + emote.id + "/fullsize";
              count++;
            }
          }
        }
        log(count ? "‚úÖ Kick emotes " + count : "‚ö†Ô∏è No emotes Kick");
      } catch (e) {
        log("‚ùå Error Kick emotes");
      }
    }
  };
  xhr.send();
}

/* ===== GET CHATROOM ID ===== */
function getChatroomId(name, cb) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://kick.com/api/v2/channels/" + name);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var data = JSON.parse(xhr.responseText);
        var id = data.chatroom && data.chatroom.id;
        if (id) {
          cb(id);
        } else {
          log("‚ö†Ô∏è Sin chatroom");
        }
      } catch (e) {
        log("‚ùå Error API canal");
      }
    }
  };
  xhr.send();
}

/* ===== SUBSCRIBE ===== */
function joinChannel(name) {
  getChatroomId(name, function(id) {
    rooms[id] = true;
    if (ws.readyState === 1) {
      ws.send(JSON.stringify({
        event: "pusher:subscribe",
        data: { auth: "", channel: "chatrooms." + id + ".v2" }
      }));
      load7TV(name);
      loadKickEmotes(name);
      log("üì° Conectado al chat");
    }
  });
}

/* ===== PARSE EMOTES ===== */
function parseEmotes(text) {
  return text.replace(/\[emote:\d+:(.+?)\]/g, function(match, name) {
    return emotes[name] ? "<img class='chat-emote' src='" + emotes[name] + "'>" : name;
  });
}

/* ===== NAME COLOR ===== */
function nameColor(n) {
  var h = 0;
  for (var i = 0; i < n.length; i++) {
    h += n.charCodeAt(i);
  }
  return "hsl(" + (h % 360) + ",70%,75%)";
}

/* ===== SCROLL EVENT ===== */
messagesBox.addEventListener("scroll", function() {
  var atBottom = messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 50;
  if (!atBottom) {
    pauseRemoval = true;
    scrollBtn.style.display = "flex";
    clearTimeout(pauseRemovalTimer);
    pauseRemovalTimer = setTimeout(function() { 
      pauseRemoval = false; 
    }, 60000);
  } else {
    scrollBtn.style.display = "none";
  }
});

/* ===== ADD MSG ===== */
function addMsg(user, text) {
  var atBottom = messagesBox.scrollHeight - messagesBox.scrollTop - messagesBox.clientHeight < 50;
  
  var msgElement = document.createElement("div");
  msgElement.className = "msg";
  var color = nameColor(user);
  var parsedText = parseEmotes(text);

  msgElement.innerHTML = "<span class='username' style='color:" + color + "'>" + user + "</span><span class='colon'>:</span> <span>" + parsedText + "</span>";
  messagesBox.appendChild(msgElement);

  if (!pauseRemoval) {
    while (messagesBox.children.length > MAX_MESSAGES) {
      messagesBox.removeChild(messagesBox.firstChild);
    }
  }

  if (atBottom) {
    messagesBox.scrollTop = messagesBox.scrollHeight;
    scrollBtn.style.display = "none";
  }
}

/* ===== WS MESSAGE ===== */
ws.onmessage = function(e) {
  try {
    var data = JSON.parse(e.data);
    if (!data.data) return;
    var messageData = JSON.parse(data.data);
    if (messageData.sender && messageData.content) {
      addMsg(messageData.sender.username, messageData.content);
    }
  } catch(e) {
    // Error silencioso
  }
};

/* ===== BOTON SCROLL ===== */
scrollBtn.onclick = function() {
  messagesBox.scrollTop = messagesBox.scrollHeight;
  scrollBtn.style.display = "none";
};

/* ===== AUTO-CONNECT ===== */
setTimeout(function() { 
  joinChannel(AUTO_CHANNEL); 
}, 800);
</script>

</body>
</html>
